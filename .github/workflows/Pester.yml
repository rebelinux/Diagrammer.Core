name: Run Pester Tests

on:
    push:
        branches: ["dev", "main"]
    pull_request:
        branches: ["dev"]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5

            - name: Run Pester tests
              uses: PSModule/Invoke-Pester@v3
              id: action-test
              with:
                  Path: "./tests"
                  TestResult_Enabled: "true"
                  TestResult_OutputPath: "./test-results.xml"

            - name: Process test results
              if: always()
              run: |
                  Write-Output "Total tests: ${{ steps.action-test.outputs.TotalCount }}"
                  Write-Output "Passed tests: ${{ steps.action-test.outputs.PassedCount }}"
                  Write-Output "Failed tests: ${{ steps.action-test.outputs.FailedCount }}"
                  Write-Output "Failed blocks: ${{ steps.action-test.outputs.FailedBlocksCount }}"
                  Write-Output "Failed containers: ${{ steps.action-test.outputs.FailedContainersCount }}"
                  Write-Output "Test outcome: ${{ steps.action-test.outputs.Result }}"
              shell: pwsh

            - name: Take action based on test outcome
              if: steps.action-test.outputs.Result == 'Passed'
              run: echo "All tests passed! Ready to proceed with deployment."

            - name: Run Pester tests with code coverage
              id: pester
              uses: PSModule/Invoke-Pester@v4
              with:
                  Path: "./tests"
                  CodeCoverage_Enabled: "true"
                  CodeCoverage_Path: "./src"
                  CodeCoverage_OutputPath: "./coverage.xml"
                  CodeCoverage_OutputFormat: "JaCoCo"
